

#include <avr/io.h>
#include <stdio.h>
#include <avr/interrupt.h>

#include "system.h"
#include "stdioWrapper.h"
#include "usart_spi.h"
#include "adc.h"
#include "dma.h"
#include "lcd.h"
#include "dac.h"


#define BUFFER_SIZE (1024)



uint8_t sineTable[] = 
{
0x10,0x11,0x12,0x12,0x13,0x14,0x15,0x15,
0x16,0x17,0x18,0x18,0x19,0x1a,0x1a,0x1b,
0x1b,0x1c,0x1c,0x1d,0x1d,0x1e,0x1e,0x1e,
0x1f,0x1f,0x1f,0x20,0x20,0x20,0x20,0x20,
0x20,0x20,0x20,0x20,0x20,0x20,0x1f,0x1f,
0x1f,0x1e,0x1e,0x1e,0x1d,0x1d,0x1c,0x1c,
0x1b,0x1b,0x1a,0x1a,0x19,0x18,0x18,0x17,
0x16,0x15,0x15,0x14,0x13,0x12,0x12,0x11,
0x10,0xf,0xe,0xe,0xd,0xc,0xb,0xb,
0xa,0x9,0x8,0x8,0x7,0x6,0x6,0x5,
0x5,0x4,0x4,0x3,0x3,0x2,0x2,0x2,
0x1,0x1,0x1,0x0,0x0,0x0,0x0,0x0,
0x0,0x0,0x0,0x0,0x0,0x0,0x1,0x1,
0x1,0x2,0x2,0x2,0x3,0x3,0x4,0x4,
0x5,0x5,0x6,0x6,0x7,0x8,0x8,0x9,
0xa,0xb,0xb,0xc,0xd,0xe,0xe,0xf
};




//void ADC_Init(void);
void dma_test(void);



ISR(ADCA_CH0_vect)
{
    
    // If the DMA transaction is incomplete, then start the next conversion.
    if(bit_is_clear(DMA.INTFLAGS, DMA_CH0TRNIF_bp))
        adcx_start();

}


volatile uint16_t dma_data[BUFFER_SIZE];


void main(void)
{

    // System setup.
    system_clocks_init();
    system_gpio_init();
    stdioWrapper_init(&USARTC0);
    
    // Peripheral setup.
    adcx_init();
    //dac_init();
    dma_init((uint8_t *)dma_data, BUFFER_SIZE *2);
    lcd_init();
    
    PMIC.CTRL = PMIC_HILVLEN_bm;
    sei();
    
    // Test start.
    printf("Start\n");
    
    uint8_t index;
    uint8_t temp;
    
    
    for(;;)
    {

        adcx_start();
        dma_block();
        
        
        lcd_barGraph(sineTable);
        
        for(index = 0; index < 128; ++index)
        {
            if(index +1 > 127)
                sineTable[index] = sineTable[0];
            else
                sineTable[index] = sineTable[index +1];
        }
        
    }
    

    
} // End of main().


